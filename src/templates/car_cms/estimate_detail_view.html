{% extends 'car_cms/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}차다이렉트{% endblock %}

{% block extrastyle %}
    <style>
        .compareImage {
            border-radius: 1.5rem;
        }

        .insurer {
            border-bottom: 1px solid #003B4A;
            padding-left: 0.5rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .insurer:last-child {
            border-bottom: none;
        }
    </style>
{% endblock %}

{% block outerbody %}
    {% include 'car_cms/partials/navbar.html' with title="차다이렉트" %}
{% endblock %}

{% block body %}
    <div class="d-flex flex-column justify-content-center p-3" id="estimate">
        <div class="header_title" style="line-height: 2.5rem">
            <span class="h3 font-weight-bolder">{{ compare.customer_name }}</span> 고객님의<br>보험 비교견적
        </div>
        <div class="w-100 mb-3">
            <img src="{{ url }}" width="100%">
        </div>
        <div>
            <button type="button" class="btn btn-cc-primary btn-block" id="captureBtn"
                    onclick="capture()">다운로드
            </button>
            <button type="button" class="btn btn-cc-primary-outline btn-block" id="compareDetailBtn"
                    onclick="compareDetail('{{ compare.id }}')">이전
            </button>
        </div>
    </div>

{% endblock %}

{% block extrascript %}
    <script src="{% static 'vendor/html2canvas/html2canvas.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script>
        const captureBtn = document.getElementById('captureBtn')
        const compareDetailBtn = document.getElementById('compareDetailBtn')

        const autoRefresh = true

        function capture() {
            $.ajax({
                type: "POST",
                data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
                dataType: "json",
                success: async function (response) {
                    const fetchResponse = await fetch(response.url);
                    const data = await fetchResponse.blob();
                    const filename = '{{ compare.customer_name }}.png'
                    const a = document.createElement('a')
                    const url = URL.createObjectURL(data)
                    a.setAttribute('href', url)
                    a.setAttribute('download', filename)
                    a.click()
                    a.remove()
                    //const ext = 'png'

                    //const metadata = { type: `image/${ext}` };
                    //return new File([data], filename, metadata);
                },
                error: function (request, status, error) {
                    alert('다운로드 실패')
                },
            });
        }
    </script>
{% endblock %}